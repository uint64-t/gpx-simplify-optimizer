//facebook - 已禁用，避免隐私保护警告
/*
(function(d, s, id) {
var js, fjs = d.getElementsByTagName(s)[0];
if (d.getElementById(id)) return;
js = d.createElement(s); js.id = id;
js.src = "//connect.facebook.net/it_IT/sdk.js#xfbml=1&appId=455565641219872&version=v2.0";
fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
*/

//google+1 - 已禁用，避免隐私保护警告
/*
(function() {
var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
po.src = 'https://apis.google.com/js/plusone.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
})();
*/

//twitter - 已禁用，避免隐私保护警告
/*
!function(d,s,id){
var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}
}(document, 'script', 'twitter-wjs');
*/;
function filesizeHuman(a,b){if(0===a)return a;b=b||1;var c=$.t("export.units").split(",");return i=parseInt(Math.floor(Math.log(a)/Math.log(1024))),0===i&&(b=0),(a/Math.pow(1024,i)).toFixed(b)+" "+c[i]}function getPosition(a){for(var b=0,c=0;a;)b+=a.offsetLeft-a.scrollLeft+a.clientLeft,c+=a.offsetTop-a.scrollTop+a.clientTop,a=a.offsetParent;return{x:b,y:c}}function hideAll(){$(".popup").each(function(){$(this).hide()}),hideLanguages()}function chooseDownloadFormat(a){hideAll();var b=getPosition(a.currentTarget);$("#download-formats").css("top",b.y-4),$("#download-formats").show()}function chooseViewFormat(a){hideAll();var b=getPosition(a.currentTarget);$("#view-formats").css("top",b.y-4),$("#view-formats").show(),$("#download-formats").hide()}function loadGeoJSON(a){"string"==typeof a&&(a=JSON.parse(a));var b=L.geoJson(a);if(0===b.getLayers().length)throw new Error("GeoJSON has no valid layers.");return b}function convertToGeoJSON(a){if("string"==typeof a){var b=a.match(/<gpx/i)?"gpx":a.match(/kml/i)?"kml":"geojson";a=(new window.DOMParser).parseFromString(a,"text/xml"),a=toGeoJSON[b](a)}return a}function defaultParser(a){return loadGeoJSON(convertToGeoJSON(a))}function jsonify(a){var b=[],c=JSON.stringify(a,function(a,c){if("object"==typeof c){if(!b.indexOf(c))return"__cycle__";b.push(c)}return c});return c}function GeoJSONFormat(){this.param={key:"geojson",syntax:"json",name:"GeoJSON",extension:"geojson",contenttype:"appplication/json",size_header:90,size_header_options:80,size_track:50,size_track_options:0,size_node:20,size_node_options:6},this.exportData=function(a){return JSON.stringify(a)},this.display=function(a){return prettyData.json(a)}}function GPXFormat(){this.param={key:"gpx",syntax:"xml",name:"GPX",extension:"gpx",contenttype:"application/gpx+xml",size_header:186,size_header_options:30,size_track:105,size_track_options:0,size_node:48,size_node_options:54},this.exportData=function(a,b){if(a.features&&a.features[0].geometry){a.features[0].geometry.times=[];for(var c in a.features[0].geometry.coordinates){var d=a.features[0].geometry.coordinates[c][1]+","+a.features[0].geometry.coordinates[c][0];a.features[0].geometry.times.push(b.rawData[d]&&b.rawData[d].time?b.rawData[d].time:void 0)}}var e=togpx(a);return e},this.display=function(a){return prettyData.xml(a)}}function gpxParser(a){var b=null;return gpxParse.parseGpx(a,function(c,d){if(c)console.log("This GPX file has no tracks. It may be a route... Can not load as true GPX file."),b=convertToGeoJSON(a);else{for(trackNum=0;trackNum<d.tracks.length;trackNum++){var e=d.tracks[trackNum];for(segmentNum=0;segmentNum<e.segments.length;segmentNum++){var f=e.segments[segmentNum];for(pointNum=0;pointNum<f.length;pointNum++){var g=f[pointNum];RAW_DATA[g.lat+","+g.lon]=g}}}b=convertToGeoJSON(a)}}),L.geoJson(b)}function KMLFormat(){this.param={key:"kml",syntax:"xml",name:"KML",extension:"kml",contenttype:"application/vnd.google-earth.kml+xml",size_header:130,size_header_options:120,size_track:120,size_track_options:0,size_node:21,size_node_options:5},this.exportData=function(a){return tokml(a)},this.display=function(a){return prettyData.xml(a)}}function MediawikiFormat(){this.param={key:"mediawiki",syntax:"nohighlight",name:"Mediawiki",extension:"txt",contenttype:"text/plain",size_header:0,size_header_options:0,size_track:0,size_track_options:0,size_node:17,size_node_options:0},this.exportData=function(a){return geojsonToPath(a)}}$("#export-close").on("click",function(){$("#export-format").hide()});var Format=function(){this.param={key:"format",name:"RootFormat"},this.formats=[]};Format.prototype={loadAll:function(a){for(var b=0;b<a.length;b++)f=new window[a[b]],f.load(),this.formats.push(f)},load:function(){var a=document.createElement("a"),b=document.createTextNode($.t("export.viewin",{format:this.param.name}));a.appendChild(b),a.title=$.t("export.viewtitle",{format:this.param.name}),a.className="view",$(a).on("click",this.viewClick.bind(this)),$("#view-formats").append(a),a=document.createElement("a"),b=document.createTextNode($.t("export.downloadin",{format:this.param.name})),a.appendChild(b),a.title=$.t("export.downloadtitle",{format:this.param.name}),a.className="download",$(a).on("click",this.saveClick.bind(this)),$("#download-formats").append(a)},display:function(a){return a},getSize:function(a,b,c){return filesizeHuman(this.getEstimatedSize(a,b,c),0)},getEstimatedSize:function(a,b,c){var d=0;return Object.keys(c).length&&(d=b*this.param.size_node_options,d+=this.param.size_header_options,d+=a*this.param.size_track_options),this.param.size_header+a*this.param.size_track+b*this.param.size_node+d},groupData:function(a){for(var b,c=a.simplifiedLayerData,d=L.geoJson(null),e=0;e<c.length;e++)window.map.hasLayer(c[e].getLayers()[0])&&(b=c[e].getLayers()[0].toGeoJSON(),d.addData(b));return this.exportData(d.toGeoJSON(),a)},save:function(a){name=a.name.replace(/\..*/,""),name=name+"_"+a.simplifiedLayerNodes+"nodes."+this.param.extension;try{if(new Blob){var b=this.groupData(a),c=new Blob([b],{type:this.param.contenttype+";charset=utf-8"});saveAs(c,name)}}catch(d){alert($.t("upload.none")+" "+d.message),console.log(d.message)}hideAll()},saveClick:function(){this.save(window.currentLayer)},view:function(a){try{if(new Blob){var b=this.groupData(a);b=this.display(b),$("code").attr("class",this.param.syntax),$("#export-content").text(b),a.simplifiedLayerNodes<1e3&&"undefined"!=typeof hljs&&$("code").each(function(a,b){hljs.highlightBlock(b)}),$("#export-format h5").html($.t("export.title",{format:this.param.name})),$("#export-format").show()}}catch(c){alert($.t("upload.none")+" "+c.message),console.log(c.message)}hideAll()},viewClick:function(){this.view(window.currentLayer)}},GeoJSONFormat.prototype=new Format,GPXFormat.prototype=new Format,RAW_DATA={},KMLFormat.prototype=new Format,MediawikiFormat.prototype=new Format;;
function hideLanguages(){$(".leaflet-control-lang a.lang").each(function(){$(this).hide()})}function switchLanguage(){hideLanguages(),window.location.href="?setLng="+$(this).attr("data-lang").toLowerCase()}function initLanguage(){var a,b=$(".leaflet-control-lang").get(0);for(var c in window.languages)a=L.DomUtil.create("a","",b),a.innerHTML=window.languages[c],a.className="lang",$(a).attr("data-lang",c),L.DomEvent.on(a,"click",switchLanguage.bind(a))}function showLanguage(){hideAll(),$(".leaflet-control-lang a.lang").each(function(){$(this).show()})}$.i18n.init({ns:{namespaces:["ns.special"],defaultNs:"ns.special"},useLocalStorage:!1,getAsync:!1,lng:"en",fallbackLng:"en",debug:!1},function(){$("body").i18n()}),window.languages={En:"English",It:"Italiano",Fr:"Français"};;
function updateLayers(){$(".leaflet-control-switcher").html("");for(var a in window.Layers){var b=window.Layers[a];$(".leaflet-control-switcher").append('<option value="'+b.id+'" '+(window.currentLayer.name==b.name?' selected="selected"':"")+">"+b.name+"</option>")}Object.keys(window.Layers).length>0?$(".leaflet-control-switcher-box").show():$(".leaflet-control-switcher-box").hide()}function clearMap(){for(var a in window.Layers)window.Layers[a].remove();window.Layers={},updateLayers()}function isValidCoordinate(a){return a&&(2===a.length||3===a.length)&&!isNaN(a[0])&&!isNaN(a[1])&&isFinite(a[0])&&isFinite(a[1])}function isValidCoordinateForSimplification(a){return a&&(2===a.length||3===a.length)&&"number"==typeof a[0]&&"number"==typeof a[1]&&!isNaN(a[0])&&!isNaN(a[1])&&isFinite(a[0])&&isFinite(a[1])}var LayerOptimizer=function(a){this.id=this.createId(),this.name=a.filename,this.sourceLayer=a.layer,this.size=a.layer.getLayers().length,this.sourceLayerStyle={color:"red",opacity:.7,fillOpacity:.7,weight:5,clickable:!1},this.sourceLayerData=[],this.sourceLayerJSON=[],this.sourceLayerOptions=[],this.sourceLayerNodes=0,this.simplifiedLayerStyle={color:"blue",opacity:1,fillOpacity:1,weight:2,clickable:!1},this.simplifiedLayerData=[],this.simplifiedLayerNodes=0,this.controller=null,this.tolerance=0,"undefined"==typeof RAW_DATA&&(window.RAW_DATA={}),this.rawData=JSON.parse(JSON.stringify(RAW_DATA)),RAW_DATA={},"function"==typeof this.init?this.init():console.error("LayerOptimizer.prototype.init is not defined")};LayerOptimizer.prototype={init:function(){for(var a,b=[],c=0;c<this.size;c++)if(a=this.sourceLayer.getLayers()[c].toGeoJSON(),"GeometryCollection"===a.geometry.type)for(var d=0;d<a.geometry.geometries.length;d++){var e=JSON.parse(JSON.stringify(a));e.geometry=a.geometry.geometries[d],e.properties.name=a.properties.name+" #"+d,e.geometry.coordinates=e.geometry.coordinates[0],b.push(e)}else b.push(a);this.size=b.length;for(var f=0;f<this.size;f++)this.initLayer(b[f],f)},initLayer:function(a,b){if(this.sourceLayerOptions[b]={},console.log("Processing layer",b,"Type:",a.geometry.type,"Coords structure:",a.geometry.coordinates),"LineString"!==a.geometry.type){this.sourceLayerOptions[b].type=a.geometry.type;var c=a.geometry.coordinates,d=c;try{if("Point"===a.geometry.type?(console.log("Skipping Point geometry - cannot convert to LineString"),this.sourceLayerJSON[b]=a):"Polygon"===a.geometry.type?c=c[0]:"MultiPolygon"===a.geometry.type?c=c.reduce(function(a,b){return a.concat(b[0])},[]):"MultiLineString"===a.geometry.type&&(c=c.reduce(function(a,b){return a.concat(b)},[])),console.log("Coords after conversion:",c),console.log("Coords length:",c.length),console.log("First coord:",c[0]),c&&c.length>0&&"number"==typeof c[0]&&(c=[c]),console.log("Final coords structure:",c),console.log("First coord validation test:",c[0],"isValid:",isValidCoordinate(c[0])),c[0]&&c[0].length>0&&(console.log("First coord types:",typeof c[0][0],typeof c[0][1],typeof c[0][2]),console.log("First coord values:",c[0][0],c[0][1],c[0][2])),c=c.filter(isValidCoordinate),console.log("Filtered coords:",c),c.length>=2){var e={type:"Feature",properties:a.properties,geometry:{type:"LineString",coordinates:c}};this.sourceLayerJSON[b]=e,console.log("Successfully converted",a.geometry.type,"to LineString with",c.length,"coordinates")}else console.warn("Failed to convert geometry to LineString, using original. Original coords:",d.length,"Valid coords:",c.length),this.sourceLayerJSON[b]=a}catch(f){console.error("Error converting geometry:",f,"Original:",a.geometry.type,"Coords:",d),this.sourceLayerJSON[b]=a}}else this.sourceLayerJSON[b]=a;this.sourceLayerData[b]=L.geoJson(null,{style:this.sourceLayerStyle}).addTo(window.map),this.sourceLayerData[b].addData(a),this.sourceLayerNodes+=a.geometry.coordinates.length,this.simplifiedLayerNodes+=a.geometry.coordinates.length;try{this.simplifiedLayerData[b]=L.geoJson(null,{style:this.simplifiedLayerStyle}).addTo(window.map),this.simplifiedLayerData[b].addData(this.sourceLayerJSON[b])}catch(f){console.error("Error creating simplified layer:",f,"Layer:",this.sourceLayerJSON[b]),this.simplifiedLayerData[b]=L.geoJson(a,{style:this.simplifiedLayerStyle}).addTo(window.map)}},choose:function(){this.zoom(),this.createLayerGroup(),this.displayInfos(),this.displaySizeFormats(),$("#slider").slider("setValue",this.tolerance)},optimize:function(a){this.simplifiedLayerNodes=0;for(var b,c,d=0;d<this.size;d++)try{var e=this.sourceLayerJSON[d].geometry.coordinates;if(!e||!Array.isArray(e)||0===e.length){console.warn("Invalid coordinates for layer",d,":",e);continue}var f=e.filter(isValidCoordinateForSimplification);if(f.length<2){console.warn("Not enough valid coordinates for layer",d,":",f.length);continue}b=simplifyGeometry(f,a);var g=this.simplifiedLayerData[d].getLayers();if(!g||0===g.length){console.warn("No layers found for simplified data",d);continue}if(c=g[0].toGeoJSON(),1===b.length&&void 0===b[0]&&(b=[]),b=b.filter(isValidCoordinate),0===b.length){console.warn("No valid coordinates after simplification for layer",d);continue}c.geometry.coordinates=b,this.simplifiedLayerData[d].clearLayers(),this.simplifiedLayerData[d].addData(c),this.simplifiedLayerNodes+=b.length}catch(h){console.error("Error optimizing layer",d,":",h);continue}this.displaySizeFormats(),this.tolerance=a},getBounds:function(){return this.sourceLayer.getBounds()},zoom:function(){window.map.fitBounds(this.getBounds())},createLayerGroup:function(){for(var a,b={},c=0;c<this.size;c++)this.sourceLayerData[c]&&this.simplifiedLayerData[c]?(a=this.sourceLayerJSON[c].properties&&this.sourceLayerJSON[c].properties.name?this.sourceLayerJSON[c].properties.name:this.name+" - "+$.t("layers.track")+" "+c,b[$.t("layers.simplified")]=this.simplifiedLayerData[c],b[$.t("layers.source")]=this.sourceLayerData[c]):console.warn("Skipping layer",c,"- missing layer data");Object.keys(b).length>0?(this.controller=L.control.layers(null,b,{collapsed:!1}),this.controller.addTo(window.map),$(".leaflet-control-layers-selector").on("click",function(){window.currentLayer.displaySizeFormats()})):console.warn("No valid layers to display")},displayInfos:function(){var a=$.t("layers.infos.title",{name:this.name}),b=$.t("layers.infos.nodes",{sourcenodes:this.sourceLayerNodes,simplifiednodes:this.simplifiedLayerNodes});$("#filename").html(a),$("#nodes").html(b),$(".leaflet-control-stats").show()},countTracksNodes:function(a){a=a||this.simplifiedLayerData;for(var b=0,c=0,d=0;d<this.size;d++)layer=a[d].getLayers()[0],window.map.hasLayer(layer)&&(b++,c+=layer.toGeoJSON().geometry.coordinates.length);return{tracks:b,nodes:c}},displaySizeFormats:function(){var a=this.countTracksNodes(),b=this.countTracksNodes(this.sourceLayerData),c=window.formats.formats,d="",e=0;$("#size-format .sizes").html(""),e=c[0].getSize(b.tracks,b.nodes,this.rawData),d="Original",$("#size-format .sizes").append('<p><span class="format-name">'+d+' :</span><span class="format-size">'+e+"</span></p>");for(var f=0;f<c.length;f++)e=c[f].getSize(a.tracks,a.nodes,this.rawData),$("#size-format .sizes").append('<p><span class="format-name">'+c[f].param.name+' :</span><span class="format-size">'+e+"</span></p>");$("#size-format").show()},clearInfos:function(){$("#filename").html(""),$("#nodes").html(""),$(".leaflet-control-stats").hide()},clearSizeFormats:function(){$("#size-format").hide()},remove:function(){this.removeLayers(),this.removeController(),this.clearInfos(),this.clearSizeFormats()},removeLayers:function(){for(var a=0;a<this.size;a++){try{window.map.removeLayer(this.sourceLayerData[a])}catch(b){console.log($.t("layers.error.layer"))}try{window.map.removeLayer(this.simplifiedLayerData[a])}catch(b){console.log($.t("layers.error.layer"))}}},removeController:function(){try{void 0!==this.controller._map&&this.controller.removeFrom(window.map)}catch(a){console.log($.t("layers.error.controller"))}},createId:function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+a()+a()}};;
$(function(){var a=new L.Map("map",{zoomControl:!1,attributionControl:!1}).setView(L.latLng(41.9,12.5),3).on("click",hideAll);window.map=a,L.tileLayer("https://a.tile.osm.org/{z}/{x}/{y}.png").addTo(a),window.Layers={},window.currentLayer=null,L.control.zoom({zoomInTitle:$.t("actions.zoomin"),zoomOutTitle:$.t("actions.zoomout")}).addTo(a),L.Control.FileLayerLoad.LABEL='<i class="fa fa-folder-open"></i>',L.Control.FileLayerLoad.TITLE=$.t("actions.upload");var b=L.Control.fileLayerLoad({addToMap:!1,fitBounds:!1,fileSizeLimit:8096,parsers:{gpx:gpxParser},binaryFormats:[]}).addTo(a);b.loader.on("data:loaded",function(a){hideAll(),window.currentLayer&&window.currentLayer.removeController();var b=new LayerOptimizer(a);b.choose(),window.Layers[b.id]=b,window.currentLayer=b,updateLayers()}).on("data:error",function(a){console.log("ERROR",a.error)}),function(){var a=new L.Control({position:"topleft"});return a.onAdd=function(){var a=L.DomUtil.create("div","leaflet-control-download leaflet-bar"),b=L.DomUtil.create("a","",a);return b.href="#",b.target="_blank",b.title=$.t("actions.download"),b.innerHTML='<i class="fa fa-download"></i>',L.DomEvent.on(b,"click",L.DomEvent.stop).on(b,"click",chooseDownloadFormat),a},a}().addTo(a),function(){var a=new L.Control({position:"topleft"});return a.onAdd=function(){var a=L.DomUtil.create("div","leaflet-control-view leaflet-bar"),b=L.DomUtil.create("a","",a);return b.href="#",b.target="_blank",b.title=$.t("actions.view"),b.innerHTML='<i class="fa fa-eye"></i>',L.DomEvent.on(b,"click",L.DomEvent.stop).on(b,"click",chooseViewFormat),a},a}().addTo(a),function(){var a=new L.Control({position:"topleft"});return a.onAdd=function(){var a=L.DomUtil.create("div","leaflet-control-erase leaflet-bar"),b=L.DomUtil.create("a","",a);return b.href="#",b.target="_blank",b.title=$.t("actions.clear"),b.innerHTML='<i class="fa fa-eraser"></i>',L.DomEvent.on(b,"click",L.DomEvent.stop).on(b,"click",clearMap).on(b,"click",hideAll),a},a}().addTo(a),L.control.attribution({position:"topright",prefix:'<a href="http://leafletjs.com/">Leaflet</a> &bull; <a href="http://osm.org/" target="_blank" data-i18n="osm.contributors">'+$.t("osm.contributors")+"</a>"}).addTo(a),function(){var a=new L.Control({position:"topleft"});return a.onAdd=function(){var a=L.DomUtil.create("div","leaflet-control-lang leaflet-bar"),b=L.DomUtil.create("a","",a);return b.href="#",b.target="_blank",b.title=$.t("actions.lang"),$(b).addClass("first"),b.innerHTML='<i class="fa fa-flag"></i>',L.DomEvent.on(b,"click",L.DomEvent.stop).on(b,"click",showLanguage),a},a}().addTo(a),function(){var a=new L.Control({position:"bottomleft"});return a.onAdd=function(){var a=L.DomUtil.create("div","leaflet-control-stats");return a.id="stats",a.innerHTML='<span id="filename"></span><br /><span id="nodes"></span>',filename$=$("#filename",a),nodes$=$("#nodes",a),a},a}().addTo(a),function(){var a=new L.Control({position:"topright"});return a.onAdd=function(){var a=L.DomUtil.create("div","leaflet-control-switcher-box leaflet-bar"),b=L.DomUtil.create("label","",a);b.href="#",b.title=$.t("actions.switchlayer"),b.innerHTML=$.t("layers.switcher");var c=L.DomUtil.create("select","leaflet-control-switcher leaflet-bar",a);return L.DomEvent.on(c,"change",function(){window.currentLayer.removeController(),window.currentLayer=window.Layers[$(this).val()],window.currentLayer.choose()}),a},a}().addTo(a),function(){var a=new L.Control({position:"bottomright"});return a.onAdd=function(){return L.DomUtil.get("size-format")},a}().addTo(a),initLanguage(),$("#slider").slider({value:0,min:0,max:.1,step:5e-5,precision:8,tooltip:"hide"}).on("slide",function(a){window.currentLayer.optimize(Math.pow(a.value,2)),window.currentLayer.displayInfos()}).parent().width("100%"),$("#helpbtn").on("click",function(a){a.preventDefault(),$("#modal").modal("show")}),$("#donate").on("click",function(a){a.preventDefault(),$("#modalDonate").modal("show")});var c=$.cookie("tour");(!c||parseInt(c)<3)&&($("#modal").modal("show"),c=(parseInt(c)||0)+1,$.cookie("tour",c,{expires:120}));var d=new Format;window.formats=d,d.loadAll(["GPXFormat","GeoJSONFormat","KMLFormat","MediawikiFormat"]),hljs.initHighlightingOnLoad()});